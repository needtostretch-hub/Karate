<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="manifest.json" />

  <!-- iOS "Add to Home Screen" niceties (optional icons) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">

  <title>Karate Japanese Flashcards</title>

  <style>
    :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b0b0b; color: #f2f2f2; }
    .wrap { max-width: 760px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 18px; margin: 8px 0 12px; font-weight: 700; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    button, select, input {
      background: #1b1b1b; color: #f2f2f2; border: 1px solid #2a2a2a;
      padding: 10px 12px; border-radius: 12px; font-size: 14px;
    }
    button { cursor: pointer; }
    button:active { transform: translateY(1px); }
    .muted { color: #bdbdbd; font-size: 13px; }
    .card {
      margin-top: 14px;
      background: #131313; border: 1px solid #262626; border-radius: 18px;
      padding: 18px; min-height: 180px;
      display: flex; flex-direction: column; justify-content: center;
      user-select: none;
    }
    .front { font-size: 30px; font-weight: 800; line-height: 1.1; }
    .back { margin-top: 12px; font-size: 18px; line-height: 1.3; color: #d9d9d9; display: none; }
    .card.revealed .back { display: block; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; border: 1px solid #2a2a2a; background: #141414; font-size: 12px; color: #cfcfcf; }
    .footer { margin-top: 10px; display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
    .grid2 { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 14px; }
    details { margin-top: 12px; background: #121212; border: 1px solid #262626; border-radius: 14px; padding: 10px; }
    textarea {
      width: 100%; min-height: 140px; border-radius: 12px; padding: 10px;
      background: #0f0f0f; color: #f2f2f2; border: 1px solid #2a2a2a;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
    }
    .warn { color: #ffcc66; }
    .ok { color: #9ee6a8; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Karate Japanese Flashcards</h1>

    <div class="row">
      <select id="categorySelect"></select>
      <button id="shuffleBtn">Shuffle</button>
      <button id="revealBtn">Reveal</button>
      <button id="resetProgressBtn" title="Clears Got/Again counts (keeps cards)">Reset progress</button>
    </div>

    <div class="card" id="card">
      <div class="row" style="justify-content: space-between; margin-bottom: 8px;">
        <span class="pill" id="categoryPill">Category</span>
        <span class="pill" id="indexPill">0/0</span>
      </div>
      <div class="front" id="frontText">‚Äî</div>
      <div class="back" id="backText">‚Äî</div>
      <div class="footer">
        <span class="muted" id="statsText">Got: 0 ‚Ä¢ Again: 0</span>
        <span class="muted" id="hintText">Tip: tap the card to reveal</span>
      </div>
    </div>

    <div class="row" style="margin-top: 10px;">
      <button id="prevBtn">‚óÄÔ∏é Prev</button>
      <button id="nextBtn">Next ‚ñ∂Ô∏é</button>
      <button id="gotBtn">‚úÖ Got it</button>
      <button id="againBtn">üîÅ Again</button>
    </div>

    <details>
      <summary>Import / Edit cards (optional)</summary>
      <p class="muted">
        Paste CSV below with headers: <span class="pill">front,back,category</span><br/>
        Works with quoted text, so combos containing commas are fine if you wrap the front in quotes.
      </p>
      <textarea id="csvInput"></textarea>
      <div class="row">
        <button id="loadSampleBtn">Load sample deck</button>
        <button id="importBtn">Import CSV</button>
        <button id="exportBtn">Export current deck as CSV</button>
      </div>
      <p class="muted warn" id="importMsg"></p>
    </details>

    <p class="muted" style="margin-top: 12px;">
      Offline works once loaded at least once on HTTPS (GitHub Pages). iPhone: open in Safari ‚Üí Share ‚Üí Add to Home Screen.
    </p>
  </div>

  <script>
    // ---------- Storage keys ----------
    const STORAGE_DECK = "kjp_deck_v1";
    const STORAGE_PROGRESS = "kjp_progress_v1";

    // ---------- Sample deck (replace later) ----------
    const SAMPLE_DECK = [
      { front: "Rei", back: "Bow", category: "Commands" },
      { front: "Hajime", back: "Begin", category: "Commands" },
      { front: "Yame", back: "Stop", category: "Commands" },
      { front: "Soto Uke", back: "Outer block", category: "Blocks" },
      { front: "Uchi Uke", back: "Inner block", category: "Blocks" },
      { front: "Gedan Barai", back: "Low sweeping block", category: "Blocks" },
      { front: "Mae Geri", back: "Front kick", category: "Kicks" },
      { front: "Mawashi Geri", back: "Round kick", category: "Kicks" },
      { front: "Gyaku Zuki", back: "Opposite / reverse punch", category: "Punches" },
      { front: "\"Mae Geri, Mawashi Geri, Yoko Geri, Uraken, Gyakuzuki\"", back: "Front kick ‚Üí Round kick ‚Üí Side kick ‚Üí Backfist ‚Üí Reverse punch", category: "Combinations" },
    ].map(c => ({...c, front: stripOuterQuotes(c.front)}));

    function stripOuterQuotes(s) {
      const t = (s ?? "").trim();
      if (t.startsWith('"') && t.endsWith('"') && t.length >= 2) return t.slice(1, -1);
      return t;
    }

    // ---------- CSV parser that handles quotes ----------
    function parseCSV(text) {
      // Returns array of rows, each row array of cells
      const rows = [];
      let row = [];
      let cell = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        const next = text[i + 1];

        if (inQuotes) {
          if (ch === '"' && next === '"') { // escaped quote
            cell += '"';
            i++;
          } else if (ch === '"') {
            inQuotes = false;
          } else {
            cell += ch;
          }
        } else {
          if (ch === '"') {
            inQuotes = true;
          } else if (ch === ',') {
            row.push(cell);
            cell = "";
          } else if (ch === '\n') {
            row.push(cell);
            rows.push(row);
            row = [];
            cell = "";
          } else if (ch === '\r') {
            // ignore
          } else {
            cell += ch;
          }
        }
      }
      // last cell
      row.push(cell);
      rows.push(row);

      // Trim cells
      return rows.map(r => r.map(c => (c ?? "").trim())).filter(r => r.some(c => c.length > 0));
    }

    function toCSV(cards) {
      const esc = (s) => {
        const t = (s ?? "").toString();
        if (t.includes('"') || t.includes(',') || t.includes('\n')) {
          return '"' + t.replaceAll('"', '""') + '"';
        }
        return t;
      };
      const lines = [["front","back","category"], ...cards.map(c => [c.front, c.back, c.category])];
      return lines.map(r => r.map(esc).join(",")).join("\n");
    }

    // ---------- App state ----------
    let deck = loadDeck();
    let progress = loadProgress(); // { got: number, again: number }
    let filtered = [];
    let idx = 0;

    // ---------- UI ----------
    const categorySelect = document.getElementById("category
